<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>Lury - Hugin</title>
  <script src="../common/loader.js"></script>
  <script type="text/javascript">loader_load('../')</script>
</head>
<body>
  <div class="container">
    <div class="row">
      <div class="col-main markdown">

## Lury

<section id="201504">
### 2015年4月

<section id="20150416">
#### 16日

最近はLuryの[仕様](http://lury-lang.github.io/lury-specification/0.1/ja/reference/)の字句解析部分がほぼまとまったので何も考えずに字句解析器を作っていた。研究用コンピュータで[ここにある入力ファイル群](https://github.com/lury-lang/lury-lexer/tree/f9f028be39a72f2ad959f92792cc226856f810f0/UnitTest/Input)をすべて解析し終わるのにおよそ100〜130ms ほどかかった。それぞれの lr 拡張子のファイルと、想定したトークンが正常に出力されているかを照合する作業を加えた値であるが、若干遅めの値であると感じた。ほとんどのファイルはそこまでトークン数は多くないし、最も大きい [Keywords.lr](https://github.com/lury-lang/lury-lexer/blob/f9f028be39a72f2ad959f92792cc226856f810f0/UnitTest/Input/Keywords.answer) でさえも 501 トークンである。

現状はかなり遅い部類。原因は何を隠そう、正規表現で無駄にマッチングをかけているから。

たとえば演算子は単なる文字列の一致を確かめればいいだけだし、煩わしさとソースの可読性を無視すれば正規表現を使わずに書ける。ただ、最初からトークンの形が変化しない `++` とか `>>=` とかの演算子、デリミタ、空白スペースは正規表現でする必要はないと思う。

.NET の正規表現について調べていたら、興味深い記述を見つけた。[.NET Framework での正規表現に関するベスト プラクティス](https://msdn.microsoft.com/ja-jp/library/gg578045%28v=vs.110%29.aspx) によると、

<blockquote>
  <p>(略) 有効な電子メール エイリアスは、その長さに関係なくほとんど同じ時間で処理されます。 一方、有効に近い電子メール アドレスでは、長さが 5 文字を超えると、文字列の文字が 1 文字増えるたびに処理時間が約 2 倍に増加します。 つまり、有効に近い文字列の長さが 28 文字になると処理に 1 時間以上かかり、33 文字になるとほぼ 1 日かかることになります。</p>
  <p>この正規表現は、一致する入力の形式ばかりを念頭に置いて開発されていて、パターンに一致しない入力のことが考慮されていません。 そのため、制約のない入力が正規表現パターンにほぼ一致する場合に、パフォーマンスが大幅に低下する可能性があります。</p>
</blockquote>

とのことだ。要するに、_正規表現パターンにほぼ一致するがマッチングしない入力_が与えられたときに正規表現のパフォーマンスが大幅悪化するということだ。前述の非効率さに加え、正規表現にマッチしなければ次の正規表現...とたらい回しにしている現状ではあまり良いパフォーマンスは得られないということだ。

なお、正規表現のような静的にトークンの文字列が判明するものに関しては文字列一致を使用するよう[修正をかけた](https://github.com/lury-lang/lury-lexer/commit/c7c6257776b45378643b96099c6e5e609ce60d4b)。この結果、字句解析に65〜90msと、だいぶ効果的な結果を得た。しかし平均で 30ms 以下の結果を目指したいところではある。しばらくはその方法を考えている。


      </div>
    </div>
  </div>
</body>
</html>
